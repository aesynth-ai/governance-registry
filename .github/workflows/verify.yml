name: Verify & Reflect







on:



  pull_request:



  push:



    branches: [ main ]







permissions:



  contents: read







env:



  BBC_JUR: BBC.v0.1.0.TW



  SYNTHLEX_SEED: '42'







concurrency:



  group: ci-${{ github.ref }}



  cancel-in-progress: false







jobs:



  verify:



    runs-on: ubuntu-latest



    steps:



      - uses: actions/checkout@v4







      - uses: pnpm/action-setup@v4



        with:



          version: 9







      - uses: actions/setup-node@v4



        with:



          node-version: '20'



          cache: 'pnpm'







      - name: Cache pnpm store



        uses: actions/cache@v4



        with:



          path: ~/.pnpm-store



          key: pnpm-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}



          restore-keys: pnpm-${{ runner.os }}-







      - name: Install OPA (pinned)



        run: |



          OPA_URL="https://openpolicyagent.org/downloads/v0.65.0/opa_linux_amd64_static"



          OPA_SHA="CD6B0B2D762571A746F0261890B155E6DD71CCA90DAD6B42B6FCF6DD7F619F08"



          curl -sSL -o opa "$OPA_URL"



          echo "$OPA_SHA  opa" | sha256sum -c -



          chmod +x opa && sudo mv opa /usr/local/bin/opa







      - name: Install dependencies



        run: pnpm install --frozen-lockfile







      - name: Build & tests



        run: |



          pnpm -r build --if-present



          pnpm -r test --if-present



          opa test policy/ -v







      - name: Generate plan artifacts



        run: node scripts/generate-plan-artifacts.mjs







      - name: Generate CivSynth plan artifacts



        run: node scripts/generate-civsynth-plan-artifacts.mjs







      - name: Determinism check



        run: node scripts/check-plan-determinism.mjs --out reports/plans







      - name: Schema validations



        run: |



          npx ajv validate --spec=draft2020 -c ajv-formats -s schemas/plan.schema.json -d 'reports/plans/*.json'



          npx ajv validate --spec=draft2020 -c ajv-formats -s codes/${{ env.BBC_JUR }}/bbc.rules.schema.json -d codes/${{ env.BBC_JUR }}/bbc.rules.yaml



          npx ajv validate --spec=draft2020 -c ajv-formats -s policy/waivers.schema.json -d policy/waivers.yaml







      - name: Validate CivSynth city plans



        if: "hashFiles('reports/civsynth/city_plans/*.json') != ''"



        run: |



          npx ajv validate --spec=draft2020 -c ajv-formats             -s governance/schemas/civsynth/city_plan.schema.json             -d "reports/civsynth/city_plans/*.json"



      - name: Validate jurisdiction manifests
        run: |
          npx ajv validate --spec=draft2020 -c ajv-formats \
            -s governance/schemas/federation/FEDS.v1.0.0.schema.json \
            -d codes/*/jurisdiction.json
      - name: Contract smoke



        run: node scripts/contract-smoke.mjs reports/plans











      - name: Validate severity-map help links



        run: |



          node -e "const fs=require('fs');const map=JSON.parse(fs.readFileSync('policy/severity-map.json','utf8'));const missing=Object.entries(map).filter(([_,v])=>v.helpUri&&!fs.existsSync(v.helpUri));if(missing.length){console.error('Missing help docs:',missing.map(([k])=>k).join(', '));process.exit(1);}}"







      - name: Waiver expiry sentinel



        env:



          WAIVER_WINDOW_DAYS: '14'



          WAIVER_ENFORCE: 'false'



        run: node scripts/waiver-sentinel.mjs







      - name: Rule changelog + version gate



        run: |



          BASE=${{ github.base_ref || 'origin/main' }}



          CHANGED=$(git diff --name-only "$BASE"...${{ github.sha }} | grep 'codes/.*/bbc.rules.yaml' || true)



          if [ -n "$CHANGED" ]; then



            git diff --name-only "$BASE"...${{ github.sha }} | grep -q 'codes/CHANGELOG.md' || (echo "Rule changed without codes/CHANGELOG.md" && exit 1)



            OLD=$(git show "$BASE":$(echo $CHANGED) | grep '^  version:' | awk '{print $2}')



            NEW=$(grep '^  version:' $CHANGED | awk '{print $2}')



            [ "$OLD" != "$NEW" ] || (echo "meta.version not bumped" && exit 1)



          fi







      - name: Judge v1.0 verification



        run: pnpm run judge

      - name: Write federation provenance



        run: pnpm run federation:prov







      - name: CivSynth verify (experimental)

        if: "hashFiles('reports/civsynth/city_plans/*.json') != ''"

        run: node scripts/civsynth-verify.mjs



      - name: SARIF + summary



        run: |



          node scripts/bbc-to-sarif.mjs reports/bbc-*.json > reports/bbc.sarif



          node -e "const fs=require('fs');const summary=JSON.parse(fs.readFileSync('reports/bbc-summary.json','utf8'));const top=Object.entries(summary.counts_by_code||{}).slice(0,5).map(([k,v])=>'- '+k+': '+v);const md=['# BBC Summary','','**Failing:** '+summary.failing,'**Suppressed:** '+summary.suppressed,'','**Top violations:**',...top];fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, md.join('\n')+'\n');"



          node -e "const fs=require('fs');const w=JSON.parse(fs.readFileSync('reports/waiver-expiring.json','utf8'));const md=['','## Waivers','Expiring ='+w.window_days+'d: **'+w.count+'**'];fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, md.join('\n')+'\n');"



          node -e "const fs=require('fs');const file='reports/bbc-history.jsonl';if(!fs.existsSync(file)){process.exit(0);}const raw=fs.readFileSync(file,'utf8').trim();if(!raw)process.exit(0);const rows=raw.split('\n').filter(Boolean).slice(-30).map(JSON.parse);if(!rows.length)process.exit(0);const perDay={};for(const row of rows){const day=row.ts.slice(0,10);perDay[day]=(perDay[day]||0)+(row.status==='FAIL'?1:0);}const days=Object.keys(perDay).sort();const values=Object.values(perDay);const max=Math.max(...values,1);const blocks='???_???¦';const spark=days.map(d=>blocks[Math.round((perDay[d]/max)*(blocks.length-1))]).join('');const md=['','## BBC Trend (last 30 runs)','Failures/day:','`'+spark+'`'];fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, md.join('\n')+'\n');"







      - name: Constitution hashes + provenance



        run: |



          node scripts/hash-constitutions.mjs



          node scripts/write-provenance.mjs







      - name: Verify provenance signature (enforced)



        env:



          PROV_PUBLIC_KEY: ${{ secrets.PROV_PUBLIC_KEY }}



          PROV_ENFORCE_SIGNATURE: 'true'



        run: |



          if [ -z "$PROV_PUBLIC_KEY" ]; then



            echo "No PROV_PUBLIC_KEY provided"



            if [ "$PROV_ENFORCE_SIGNATURE" = "true" ]; then exit 1; else exit 0; fi



          fi



          printf "%s" "$PROV_PUBLIC_KEY" > /tmp/prov.pub.asc



          gpg --batch --yes --import /tmp/prov.pub.asc



          if [ ! -f reports/provenance.json.asc ]; then



            echo "Missing provenance signature"



            if [ "$PROV_ENFORCE_SIGNATURE" = "true" ]; then exit 1; else exit 0; fi



          fi



          gpg --batch --yes --verify reports/provenance.json.asc reports/provenance.json







      - uses: actions/upload-artifact@v4



        with:



          name: bbc-artifacts



          path: |



            reports/*.json



            reports/*.sarif







  reflection:



    needs: verify



    if: ${{ always() }}



    uses: aesynth-ai/governance-registry/.github/workflows/_reusable-reflection.yml@main



    with:



      min_hours: 12



    secrets: inherit





