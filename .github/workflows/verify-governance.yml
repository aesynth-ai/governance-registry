name: verify-governance

on:
  pull_request:
    paths:
      - "registry.yaml"
      - "docs/**"
      - "schemas/**"
      - "keys/**"
      - "ci/**"
      - "logs/**"
  push:
    branches: [ main ]
    paths:
      - "registry.yaml"
      - "docs/**"
      - "schemas/**"
      - "keys/**"
      - "ci/**"
      - "logs/**"

jobs:
  verify:
    name: Verify Governance Corpus
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install toolchain (yamllint, ajv, yq)
        run: |
          python3 -m pip install --upgrade pip yamllint
          npm i -g ajv-cli@5.0.0
          curl -L "https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64" -o /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: YAML lint (policy-driven)
        run: |
          # If you maintain a yamllint schema in ci/rules.yaml, use it; else fallback to relaxed defaults.
          if [ -f ci/rules.yaml ]; then
            yamllint -c ci/rules.yaml .
          else
            yamllint -d "{extends: default, rules: {line-length: {max: 220}}}" .
          fi

      - name: Schema: compile governance-ledger.schema.yaml
        run: |
          test -f schemas/governance-ledger.schema.yaml
          yq -o=json schemas/governance-ledger.schema.yaml > /tmp/ledger.schema.json
          # quick sanity: ajv compile
          ajv compile -s /tmp/ledger.schema.json

      - name: Validate Policy Registry against schema
        run: |
          test -f docs/policy/PolicyRegistry.yaml
          yq -o=json docs/policy/PolicyRegistry.yaml > /tmp/policy.json
          ajv validate -s /tmp/ledger.schema.json -d /tmp/policy.json

      - name: Registry index integrity
        run: |
          # Ensure required anchors exist & versions are coherent with folder names.
          yq '.documents.technical_constitution.path // ""' registry.yaml | grep 'docs/constitutions/technical-constitution/'
          yq '.documents.human_constitution.path // ""' registry.yaml     | grep 'docs/constitutions/human-constitution/'
          yq '.documents.semantic_charter.path // ""' registry.yaml       | grep 'docs/charters/semantic-charter/'
          # Version folder ↔ YAML version match (fail if mismatch)
          tc_dir=$(dirname "$(yq -r '.documents.technical_constitution.path' registry.yaml)")
          tc_ver=$(basename "$tc_dir")
          yq -r '.version' "$tc_dir/Constitution.yaml" | grep -x "$tc_ver"
          hc_dir=$(dirname "$(yq -r '.documents.human_constitution.path' registry.yaml)")
          hc_ver=$(basename "$hc_dir")
          yq -r '.version' "$hc_dir/Constitution.yaml" | grep -x "$hc_ver"

      - name: Trust metadata sanity
        run: |
          test -f keys/trust-metadata.yaml
          # Must have at least one key with id + fingerprint
          [ "$(yq '.keys | length' keys/trust-metadata.yaml)" -ge 1 ]
          yq '.keys[] | {id: .id, fp: .fingerprint}' keys/trust-metadata.yaml | grep fingerprint

      - name: Provenance log presence
        run: |
          test -f logs/BUILD_LOG.yaml
          # Non-empty and has at least one entry
          [ "$(yq '.events | length' logs/BUILD_LOG.yaml)" -ge 0 ]

      - name: Emit status
        run: echo "verify-governance: PASS"
